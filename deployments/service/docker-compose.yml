services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: chaintx
      POSTGRES_USER: chaintx
      POSTGRES_PASSWORD: chaintx
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U chaintx -d chaintx"]
      interval: 5s
      timeout: 3s
      retries: 10
    ports:
      - "${SERVICE_POSTGRES_PORT:-5432}:5432"
    volumes:
      - service-postgres-data:/var/lib/postgresql/data
    restart: unless-stopped

  app:
    build:
      context: ../..
      dockerfile: build/service/app.Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PORT: "8080"
      OPENAPI_SPEC_PATH: /app/api/openapi.yaml
      DATABASE_URL: postgresql://chaintx:chaintx@postgres:5432/chaintx?sslmode=disable
      PAYMENT_REQUEST_ALLOCATION_MODE: devtest
      PAYMENT_REQUEST_DEVTEST_KEYSETS_JSON: ${PAYMENT_REQUEST_DEVTEST_KEYSETS_JSON:-{"bitcoin":{"regtest":{"keyset_id":"ks_btc_regtest","extended_public_key":"tpubDC2pzLGKv5DoHtRoYjJsbgESSzFqc3mtPzahMMqhH89bqqHot28MFUHkUECJrBGFb2KPQZUrApq4Ti6Y69S2K3snrsT8E5Zjt1GqTMj7xn5","expected_index0_address":"bcrt1q7xfwy8t0z9xar2klctmdgm96kxvg9k8jn30qfg"},"testnet":{"keyset_id":"ks_btc_testnet","extended_public_key":"vpub5Xzfrm6ouSBPKVriRpkXyai4mvsHjRHq28wxS1znBCdwzLzeJUx8ruJeBnCMKs1AyqYsJ2mriQHuzxNoFtkkq94J4bJyNjGXkbZ8vCYwUy3","expected_index0_address":"tb1q7xfwy8t0z9xar2klctmdgm96kxvg9k8j3ckd7p"}},"ethereum":{"sepolia":{"keyset_id":"ks_eth_sepolia","extended_public_key":"xpub6BfCU6SeCoGM26Ex6YKnPku57sABcfGprMzPzonYwDPi6Yd6ooHG72cvEC7XKgK1o7nUnyxydj11mXbvhHanRcRVoGhpYYuWJ3gRhPCmQKj","expected_index0_address":"0x61ed32e69db70c5abab0522d80e8f5db215965de"},"local":{"keyset_id":"ks_eth_local","extended_public_key":"xpub6BfCU6SeCoGM26Ex6YKnPku57sABcfGprMzPzonYwDPi6Yd6ooHG72cvEC7XKgK1o7nUnyxydj11mXbvhHanRcRVoGhpYYuWJ3gRhPCmQKj","expected_index0_address":"0x61ed32e69db70c5abab0522d80e8f5db215965de"}}}}
      PAYMENT_REQUEST_KEYSET_HASH_HMAC_SECRET: ${PAYMENT_REQUEST_KEYSET_HASH_HMAC_SECRET:-local-devtest-hmac-secret-change-me}
      PAYMENT_REQUEST_KEYSET_HASH_HMAC_PREVIOUS_SECRETS_JSON: ${PAYMENT_REQUEST_KEYSET_HASH_HMAC_PREVIOUS_SECRETS_JSON:-[]}
      PAYMENT_REQUEST_RECONCILER_ENABLED: ${PAYMENT_REQUEST_APP_RECONCILER_ENABLED:-false}
      PAYMENT_REQUEST_RECONCILER_POLL_INTERVAL_SECONDS: ${PAYMENT_REQUEST_RECONCILER_POLL_INTERVAL_SECONDS:-15}
      PAYMENT_REQUEST_RECONCILER_BATCH_SIZE: ${PAYMENT_REQUEST_RECONCILER_BATCH_SIZE:-100}
      PAYMENT_REQUEST_RECONCILER_LEASE_SECONDS: ${PAYMENT_REQUEST_RECONCILER_LEASE_SECONDS:-30}
      PAYMENT_REQUEST_RECONCILER_WORKER_ID: ${PAYMENT_REQUEST_APP_RECONCILER_WORKER_ID:-}
      PAYMENT_REQUEST_RECONCILER_DETECTED_THRESHOLD_BPS: ${PAYMENT_REQUEST_RECONCILER_DETECTED_THRESHOLD_BPS:-10000}
      PAYMENT_REQUEST_RECONCILER_CONFIRMED_THRESHOLD_BPS: ${PAYMENT_REQUEST_RECONCILER_CONFIRMED_THRESHOLD_BPS:-10000}
      PAYMENT_REQUEST_RECONCILER_BTC_MIN_CONFIRMATIONS: ${PAYMENT_REQUEST_RECONCILER_BTC_MIN_CONFIRMATIONS:-1}
      PAYMENT_REQUEST_RECONCILER_EVM_MIN_CONFIRMATIONS: ${PAYMENT_REQUEST_RECONCILER_EVM_MIN_CONFIRMATIONS:-1}
      PAYMENT_REQUEST_BTC_ESPLORA_BASE_URL: ${PAYMENT_REQUEST_BTC_ESPLORA_BASE_URL:-}
      PAYMENT_REQUEST_EVM_RPC_URLS_JSON: ${PAYMENT_REQUEST_EVM_RPC_URLS_JSON:-{}}
      PAYMENT_REQUEST_DEVTEST_ALLOW_MAINNET: "false"
    ports:
      - "${SERVICE_APP_PORT:-8080}:8080"
    restart: unless-stopped

  reconciler:
    profiles:
      - reconciler
    build:
      context: ../..
      dockerfile: build/service/app.Dockerfile
    depends_on:
      postgres:
        condition: service_healthy
    entrypoint: ["/usr/local/bin/reconciler"]
    environment:
      OPENAPI_SPEC_PATH: /app/api/openapi.yaml
      DATABASE_URL: postgresql://chaintx:chaintx@postgres:5432/chaintx?sslmode=disable
      PAYMENT_REQUEST_ALLOCATION_MODE: devtest
      PAYMENT_REQUEST_DEVTEST_KEYSETS_JSON: ${PAYMENT_REQUEST_DEVTEST_KEYSETS_JSON:-{"bitcoin":{"regtest":{"keyset_id":"ks_btc_regtest","extended_public_key":"tpubDC2pzLGKv5DoHtRoYjJsbgESSzFqc3mtPzahMMqhH89bqqHot28MFUHkUECJrBGFb2KPQZUrApq4Ti6Y69S2K3snrsT8E5Zjt1GqTMj7xn5","expected_index0_address":"bcrt1q7xfwy8t0z9xar2klctmdgm96kxvg9k8jn30qfg"},"testnet":{"keyset_id":"ks_btc_testnet","extended_public_key":"vpub5Xzfrm6ouSBPKVriRpkXyai4mvsHjRHq28wxS1znBCdwzLzeJUx8ruJeBnCMKs1AyqYsJ2mriQHuzxNoFtkkq94J4bJyNjGXkbZ8vCYwUy3","expected_index0_address":"tb1q7xfwy8t0z9xar2klctmdgm96kxvg9k8j3ckd7p"}},"ethereum":{"sepolia":{"keyset_id":"ks_eth_sepolia","extended_public_key":"xpub6BfCU6SeCoGM26Ex6YKnPku57sABcfGprMzPzonYwDPi6Yd6ooHG72cvEC7XKgK1o7nUnyxydj11mXbvhHanRcRVoGhpYYuWJ3gRhPCmQKj","expected_index0_address":"0x61ed32e69db70c5abab0522d80e8f5db215965de"},"local":{"keyset_id":"ks_eth_local","extended_public_key":"xpub6BfCU6SeCoGM26Ex6YKnPku57sABcfGprMzPzonYwDPi6Yd6ooHG72cvEC7XKgK1o7nUnyxydj11mXbvhHanRcRVoGhpYYuWJ3gRhPCmQKj","expected_index0_address":"0x61ed32e69db70c5abab0522d80e8f5db215965de"}}}}
      PAYMENT_REQUEST_KEYSET_HASH_HMAC_SECRET: ${PAYMENT_REQUEST_KEYSET_HASH_HMAC_SECRET:-local-devtest-hmac-secret-change-me}
      PAYMENT_REQUEST_KEYSET_HASH_HMAC_PREVIOUS_SECRETS_JSON: ${PAYMENT_REQUEST_KEYSET_HASH_HMAC_PREVIOUS_SECRETS_JSON:-[]}
      PAYMENT_REQUEST_RECONCILER_ENABLED: ${PAYMENT_REQUEST_RECONCILER_ENABLED:-true}
      PAYMENT_REQUEST_RECONCILER_POLL_INTERVAL_SECONDS: ${PAYMENT_REQUEST_RECONCILER_POLL_INTERVAL_SECONDS:-15}
      PAYMENT_REQUEST_RECONCILER_BATCH_SIZE: ${PAYMENT_REQUEST_RECONCILER_BATCH_SIZE:-100}
      PAYMENT_REQUEST_RECONCILER_LEASE_SECONDS: ${PAYMENT_REQUEST_RECONCILER_LEASE_SECONDS:-30}
      PAYMENT_REQUEST_RECONCILER_WORKER_ID: ${PAYMENT_REQUEST_RECONCILER_WORKER_ID:-}
      PAYMENT_REQUEST_RECONCILER_DETECTED_THRESHOLD_BPS: ${PAYMENT_REQUEST_RECONCILER_DETECTED_THRESHOLD_BPS:-10000}
      PAYMENT_REQUEST_RECONCILER_CONFIRMED_THRESHOLD_BPS: ${PAYMENT_REQUEST_RECONCILER_CONFIRMED_THRESHOLD_BPS:-10000}
      PAYMENT_REQUEST_RECONCILER_BTC_MIN_CONFIRMATIONS: ${PAYMENT_REQUEST_RECONCILER_BTC_MIN_CONFIRMATIONS:-1}
      PAYMENT_REQUEST_RECONCILER_EVM_MIN_CONFIRMATIONS: ${PAYMENT_REQUEST_RECONCILER_EVM_MIN_CONFIRMATIONS:-1}
      PAYMENT_REQUEST_BTC_ESPLORA_BASE_URL: ${PAYMENT_REQUEST_BTC_ESPLORA_BASE_URL:-}
      PAYMENT_REQUEST_EVM_RPC_URLS_JSON: ${PAYMENT_REQUEST_EVM_RPC_URLS_JSON:-{}}
      PAYMENT_REQUEST_DEVTEST_ALLOW_MAINNET: "false"
    restart: unless-stopped

volumes:
  service-postgres-data:
