services:
  eth-node:
    image: ghcr.io/foundry-rs/foundry:v1.4.0
    environment:
      ANVIL_IP_ADDR: 0.0.0.0
    command:
      - anvil
      - --host
      - 0.0.0.0
      - --port
      - "8545"
      - --chain-id
      - "31337"
      - --mnemonic
      - test test test test test test test test test test test junk
      - --block-time
      - "1"
    ports:
      - "${ETH_RPC_PORT:-8545}:8545"
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "cast chain-id --rpc-url http://127.0.0.1:8545 >/dev/null 2>&1",
        ]
      interval: 5s
      timeout: 3s
      retries: 20
    restart: unless-stopped

  usdt-deployer:
    image: ghcr.io/foundry-rs/foundry:v1.4.0
    working_dir: /workspace
    entrypoint:
      - /bin/sh
      - -lc
    command: ./scripts/local-chains/usdt_deploy.sh
    environment:
      ETH_RPC_URL: ${ETH_RPC_URL:-http://eth-node:8545}
      ETH_EXPECTED_CHAIN_ID: "31337"
      LOCAL_CHAIN_ARTIFACT_DIR: /workspace/deployments/local-chains/artifacts
      ETH_ARTIFACT_FILE: ${ETH_ARTIFACT_FILE:-/workspace/deployments/local-chains/artifacts/eth.json}
      USDT_TOKEN_DECIMALS: ${USDT_TOKEN_DECIMALS:-6}
      USDT_MINT_AMOUNT: ${USDT_MINT_AMOUNT:-1000000000000}
      USDT_MINT_TO: ${USDT_MINT_TO:-0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266}
      PAYER_PRIVATE_KEY: ${PAYER_PRIVATE_KEY:-0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80}
    depends_on:
      eth-node:
        condition: service_healthy
    volumes:
      - ../..:/workspace
