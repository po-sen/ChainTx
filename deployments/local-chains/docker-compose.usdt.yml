services:
  usdt-node:
    build:
      context: ../..
      dockerfile: build/local-chains/usdt-node.Dockerfile
    ports:
      - "${USDT_RPC_PORT:-8546}:8545"
    working_dir: /workspace
    entrypoint:
      - /bin/sh
      - -lc
    command:
      - |
        set -eu
        anvil --host 0.0.0.0 --port 8545 --chain-id "${USDT_CHAIN_ID:-31337}" --mnemonic "test test test test test test test test test test test junk" --block-time 1 >/tmp/usdt-anvil.log 2>&1 &
        anvil_pid=$$!
        cleanup() {
          kill "$$anvil_pid" 2>/dev/null || true
        }
        trap cleanup EXIT INT TERM
        for _ in $(seq 1 90); do
          if cast chain-id --rpc-url http://127.0.0.1:8545 >/dev/null 2>&1; then
            break
          fi
          sleep 1
        done
        ./scripts/local-chains/usdt_deploy.sh
        wait "$$anvil_pid"
    environment:
      ETH_RPC_URL: ${ETH_RPC_URL:-http://127.0.0.1:8545}
      ETH_EXPECTED_CHAIN_ID: ${USDT_CHAIN_ID:-31337}
      USDT_CHAIN_ID: ${USDT_CHAIN_ID:-31337}
      USDT_ARTIFACT_RPC_URL: ${USDT_ARTIFACT_RPC_URL:-http://127.0.0.1:8546}
      LOCAL_CHAIN_ARTIFACT_DIR: /workspace/deployments/local-chains/artifacts
      LOCAL_USDT_PROJECT: ${LOCAL_USDT_PROJECT:-chaintx-local-usdt}
      USDT_TOKEN_DECIMALS: ${USDT_TOKEN_DECIMALS:-6}
      USDT_MINT_AMOUNT: ${USDT_MINT_AMOUNT:-1000000000000}
      USDT_MINT_TO: ${USDT_MINT_TO:-0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266}
      PAYER_PRIVATE_KEY: ${PAYER_PRIVATE_KEY:-0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80}
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "cast chain-id --rpc-url http://127.0.0.1:8545 >/dev/null 2>&1 && test -s /workspace/deployments/local-chains/artifacts/usdt.json",
        ]
      interval: 5s
      timeout: 5s
      retries: 30
    volumes:
      - ../..:/workspace
