---
doc: 01_requirements
spec_date: 2026-02-21
slug: webhook-status-outbox-delivery
mode: Full
status: DONE
owners:
  - posen
depends_on:
  - 2026-02-20-chain-listener-payment-reconcile
  - 2026-02-20-reconciler-horizontal-scaling
  - 2026-02-21-min-confirmations-configurable
links:
  problem: 00_problem.md
  requirements: 01_requirements.md
  design: 02_design.md
  tasks: 03_tasks.md
  test_plan: 04_test_plan.md
---

# Requirements

## Glossary (optional)

- webhook event:
- Immutable message representing a payment request status transition.
- outbox event:
- Persisted webhook delivery job stored in DB before dispatch.
- at-least-once delivery:
- Event may be delivered more than once; consumer must deduplicate by event id.
- request webhook URL:
- Destination URL provided on `POST /v1/payment-requests` and bound to that payment request.

## Out-of-scope behaviors

- OOS1: partner-specific webhook subscription management APIs.
- OOS2: webhook replay API/UI in this iteration.

## Functional requirements

### FR-001 - Status transitions enqueue webhook events atomically

- Description: when reconciler transitions payment request status, system must enqueue webhook outbox event in the same persistence operation.
- Acceptance criteria:
  - [x] AC1: transitions to `detected`, `confirmed`, `expired` generate one outbox event per successful transition.
  - [x] AC2: if transition update is not applied (status race/no-op), no outbox event is enqueued.
  - [x] AC3: event payload includes `event_id`, `event_type`, `occurred_at`, and payment request identifiers/status context.
  - [x] AC4: outbox row stores destination URL snapshot for dispatch (not global runtime URL lookup).
- Notes: this preserves atomicity between state change and notification intent.

### FR-002 - Dispatcher claims and sends outbox events with retries

- Description: background dispatcher worker must claim pending outbox records, POST webhook payload, and update delivery state.
- Acceptance criteria:
  - [x] AC1: dispatcher uses claim semantics compatible with multi-replica execution (no double-claim in one cycle).
  - [x] AC2: HTTP `2xx` marks event as delivered and clears claim lock.
  - [x] AC3: non-`2xx` or transport error increments attempts and schedules retry with bounded backoff until max attempts.
  - [x] AC4: when max attempts reached, event is marked terminal failure and no longer retried.
  - [x] AC5: dispatcher always sends to event-bound destination URL from outbox record; no global URL fallback.
- Notes: delivery semantics are at-least-once.

### FR-003 - Webhook request signing with HMAC-SHA256

- Description: outbound webhook must include signature headers so receiver can verify authenticity/integrity.
- Acceptance criteria:
  - [x] AC1: request includes timestamp header and signature header generated by `HMAC-SHA256(secret, timestamp + "." + body)`.
  - [x] AC2: signature value is deterministic for same secret/timestamp/body.
  - [x] AC3: missing webhook secret fails startup with explicit config error in webhook-dispatcher runtime.
- Notes: secret is configured via env; no DB storage.

### FR-004 - Dedicated dispatcher runtime and config surface

- Description: webhook dispatch must run as dedicated runtime/container with explicit startup validation and config surface.
- Acceptance criteria:
  - [x] AC1: `PAYMENT_REQUEST_WEBHOOK_ENABLED` controls webhook outbox producer/dispatcher activation (default `false`).
  - [x] AC2: `cmd/webhook-dispatcher` exists and starts webhook worker loop independently.
  - [x] AC3: dispatcher runtime does not require global `PAYMENT_REQUEST_WEBHOOK_URL`; destination comes from outbox event.
  - [x] AC4: poll interval, batch size, lease seconds, timeout seconds, max attempts, and backoff bounds are positive validated values.
  - [x] AC5: docker-compose and Makefile expose dedicated `webhook-dispatcher` service with independent replica scaling.
- Notes: app/reconciler no longer start webhook worker.

### FR-005 - Runtime composition decoupling between reconciler and dispatcher

- Description: composition roots must isolate runtime-specific dependencies while preserving producer/consumer integration via outbox.
- Acceptance criteria:
  - [x] AC1: server runtime wiring does not construct webhook worker.
  - [x] AC2: reconciler runtime wiring does not construct webhook HTTP gateway/worker.
  - [x] AC3: webhook-dispatcher runtime wiring does not construct HTTP server/reconciler dependencies.
  - [x] AC4: non-dispatcher runtimes can start without webhook dispatch-only settings; dispatcher runtime still fails fast on missing required dispatcher settings.
- Notes: outbox enqueue behavior remains controlled by `PAYMENT_REQUEST_WEBHOOK_ENABLED` and `PAYMENT_REQUEST_WEBHOOK_MAX_ATTEMPTS`.

### FR-006 - Payment request webhook URL is mandatory

- Description: client must provide webhook destination on every payment request creation.
- Acceptance criteria:
  - [x] AC1: `POST /v1/payment-requests` requires `webhook_url` in request payload.
  - [x] AC2: missing `webhook_url` returns validation error with explicit error code.
  - [x] AC3: accepted `webhook_url` is persisted/canonicalized and tied to payment request for subsequent status-change events.
- Notes: this requirement is mandatory (no optional mode).

### FR-007 - Webhook URL allowlist enforcement

- Description: request webhook URL must be restricted to configured allowlist.
- Acceptance criteria:
  - [x] AC1: system provides allowlist config via env `PAYMENT_REQUEST_WEBHOOK_URL_ALLOWLIST_JSON`.
  - [x] AC2: allowlist format is JSON string array (host patterns); invalid format fails startup with explicit config error.
  - [x] AC3: `webhook_url` host must match allowlist, otherwise creation fails with validation error.
  - [x] AC4: `webhook_url` scheme must be `http` or `https`; non-HTTP(S) schemes are rejected.
- Notes: purpose is SSRF risk reduction and destination control.

## Non-functional requirements

- Performance (NFR-001): webhook dispatch cycle should process configured batch size without blocking reconciler status updates.
- Availability/Reliability (NFR-002): pending events survive restarts and are retried according to configured policy.
- Security/Privacy (NFR-003): HMAC secret is never logged; signature uses HMAC-SHA256 only; allowlist enforcement blocks non-approved destinations.
- Compliance (NFR-004): not applicable in this iteration.
- Observability (NFR-005): dispatcher logs cycle counters (claimed/sent/retried/failed/errors/latency) and startup validation failures expose explicit config/error codes.
- Maintainability (NFR-006): implementation must follow ports/adapters separation (use case + outbound ports + adapters) and runtime-specific composition roots.

## Dependencies and integrations

- External systems: merchant webhook receiver endpoints over HTTP/HTTPS.
- Internal services: payment request creation flow, reconciler transition path, and PostgreSQL persistence.
